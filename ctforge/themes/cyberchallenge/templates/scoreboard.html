
{# CTForge: Forge your own CTF. #}

{# Copyright (C) 2016-2019  Marco Squarcina #}
{# Copyright (C) 2016-2019  Mauro Tempesta #}
{# Copyright (C) 2016-2019  Lorenzo Veronese #}

{# This program is free software: you can redistribute it and/or modify #}
{# it under the terms of the GNU Affero General Public License as published #}
{# by the Free Software Foundation, either version 3 of the License, or #}
{# (at your option) any later version. #}

{# This program is distributed in the hope that it will be useful, #}
{# but WITHOUT ANY WARRANTY; without even the implied warranty of #}
{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the #}
{# GNU Affero General Public License for more details. #}

{# You should have received a copy of the GNU Affero General Public License #}
{# along with this program.  If not, see <https://www.gnu.org/licenses/>. #}

{% extends "layout.html" %}
{% block title %}CTF Scoreboard{% endblock %}
{% block container_fluid %}container-fluid{% endblock %}

{% block jumbotron %}
<div class="jumbotron">
    <div class="container">
	<h1><span class="fa fa-line-chart"></span> Scoreboard</h1>
        <div>
            {% if rnd > 0 %}
            Scores computed at round <span id="rnd-scores">{{ rnd - 1 }}</span>.
            Current round <span id="rnd-current">{{ rnd }}</span>.<br>
            <span id="countdown-container">
                Next round starting in <span id="countdown"></span>
            </span>
            {% else %}
            Attack/defense CTF is coming soon
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

{% from "_macros.html" import get_status_badge %}

<!-- <meta http-equiv="refresh" content="900"> -->

<div class="card col-md-8 offset-md-2 mt-4 mb-4" id="freezeinfo" style="display: none;">
    <div class="card-body mx-auto h5 text-center">
        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
        The scoreboard is frozen.
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>

<div class="form-inline pull-right">
    <div class="form-check mb-2 mr-sm-3">
        <input class="form-check-input" type="checkbox" id="showallcheckbox">
        <label class="form-check-label" for="showallcheckbox">Show All Teams</label>
    </div>
    
    <div class="input-group mb-2 mr-sm-2">
        <input type="text" class="form-control form-control-sm" id="ticktodisplay" placeholder="Ticks to Display">
        <div class="input-group-append">
            <button class="input-group-text" id="tickstodisplay-refresh"><span class="fa fa-refresh"></span></button>
        </div>
    </div>
    
</div>

<canvas id="scoregraph" width="450" height="100"></canvas>

<div class="row mt-5">
    <div class="col-md-12">
        <table class="table scoreboard"></table>
    </div>
</div>

<div style="position: fixed; left: 60px; bottom: 20px; opacity: 0.8; z-index: 111110;">
    <button class="btn btn-small btn-primary" id="auto-scroll"><span class="fa fa-arrows-v"></span> Auto scroll</button>
</div>

<style>
 /* Add a counter to every td.counter in tbody */
 table.scoreboard tbody {
     counter-reset: rowNumber;
 }

 table.scoreboard tr {
     counter-increment: rowNumber;
 }

 table.scoreboard tr td.counter::before {
     content: counter(rowNumber);
 }
</style>

<script>
 var columns = [
     {"name": "position", "title":"#", "classes":"align-middle counter pl-4"},
     {"name": "team", "title": "Team", "classes": "align-middle text-left"},
     {% for s in services %}
     {
         "name": "{{ s.name }}",
         "title": "<a href=\"{{ url_for('service', name=s.name) }}\" class=\"btn btn-dark challenge-button {% if not s.active %}disabled{% endif %}\" role=\"button\">{{ s.name }}</a>",
         "classes": "text-center",
         "type": "html"
     },
     {% endfor %}
     {"name": "score", "title": "Global Score", "classes": "align-middle text-center", "type": "html"}
 ];

 function formatNumber(n) {
     var prefix = (n >= 0) ? "  " : " ";
     return prefix + n.toLocaleString("en-US", {"minimumFractionDigits": 2, "maximumFractionDigits": 2});
 }

 function renderService(s) {
     var integrity_check;

     if (s.integrity) {
         integrity_check = s.integrity.status ?
                           $("<span class='badge badge-success'>UP</span>") :
                           $("<span class='badge badge-danger'>CORRUPTED</span>");
         integrity_check.attr("title", "last checked at " + s.integrity.timestamp);
     } else {
         integrity_check = $("<span class=\"badge badge-warning\">NOT CHECKED</span>");
     }

     return $("<td>").append([
         $("<div>").append(integrity_check),
         $("<div title='attack' style='margin-top: 5px'>").append([
             $("<span class='fa fa-lg fa-fire' title='attack'>"),
             formatNumber(s.attack),
             $("<small>").text(' ( '+s.attack_flags).append([
                 " ",
                 $("<span class='fa fa-flag'>"),
                 " )"
             ])
         ]
         ),
         $("<div title='defense'>").append([
             $("<span class='fa fa-lg fa-shield' title='defense'>"),
             formatNumber(s.defense),
             $("<small>").text(' ( '+s.defense_flags).append([
                 " ",
                 $("<span class='fa fa-flag'>"),
                 " )"
             ])
         ]),
         $("<div title='SLA'>").append([
             $("<span class='fa fa-lg fa-wrench' title='SLA'>"),
             formatNumber(s.sla),
             $("<small>").text(' ( '+(s.sla_percentage | 0)+" % )")
         ])
     ]);
 }

 function renderScore(t) {
     return $("<td>").append([
         $("<div title='global score'>").append([
             $("<span class='fa fa-lg fa-globe' title='global score'>"), $("<span class='global-score'>").append(formatNumber(t.score))
         ]),
         $("<div title='attack'>").append([
             $("<span class='fa fa-lg fa-fire' title='attack'>"), formatNumber(t.attack)]
         ),
         $("<div title='defense'>").append([
             $("<span class='fa fa-lg fa-shield' title='defense'>"), formatNumber(t.defense)
         ]),
         $("<div title='SLA'>").append([
             $("<span class='fa fa-lg fa-wrench' title='SLA'>"), formatNumber(t.sla)
         ])
     ]);
 }

 
 function hashCode(str) {
     var hash = 0;
     for (var i = 0; i < str.length; i++) {
         hash = str.charCodeAt(i) + ((hash << 5) - hash);
     }
     return hash;
 }

 function intToRGB(i){
     var c = (i & 0x00FFFFFF)
         .toString(16)
         .toUpperCase();
     return "00000".substring(0, 6 - c.length) + c;
 }

 var ctx = document.getElementById('scoregraph').getContext('2d');
 Chart.defaults.global.animation.duration = 0;
 var scoreGraph = new Chart(ctx, {
     type: 'line',
     data: {
         labels: [],
         datasets: []
     },
     options: {
         legend: {
             position: 'bottom'
         },
         tooltips: {
             enabled: true,
         },
         scales: {
             yAxes: [{
                 scaleLabel: {
                     display: true,
                     labelString: 'Global Score'
                 }
             }],
             xAxes: [{
                 scaleLabel: {
                     display: true,
                     labelString: 'Round'
                 }
             }]
         },
     },
     
 });

 $(document).ready(function() {
     var table = FooTable.init(".scoreboard", {
         "columns": columns
     });
     var seconds_left = {{ time_left }};
     var current_round = {{ rnd }};
     var update_period = {{ rnd_duration / 20 }};

     var timer = null;
     var is_scrolling = false;
     $('#auto-scroll').click(function () {
         if (is_scrolling) {
             $('html, body').stop();
             console.log('clear')
             window.clearInterval(timer);
             is_scrolling = false;
         } else {
             is_scrolling = true;
             let auto_scroll_initial_delay = 1000;
             let auto_scroll_half_duration = 120000;
             let scroll_page = function () {
                 console.log("asdasd")
                 $('html, body').delay(auto_scroll_initial_delay).animate({
                     scrollTop: $(document).height() - $(window).height()
                 }, auto_scroll_half_duration, function () {
                     $(this).animate({
                         scrollTop: 0
                     }, auto_scroll_half_duration);
                     $(this).stop()
                 });
             }
             scroll_page();
             timer = window.setInterval(scroll_page, auto_scroll_half_duration*3);
             // stop auto scroll on some events
             $(document).on('wheel', function () {
                 $('html, body').stop();
                 console.log('clear')
                 window.clearInterval(timer);
                 is_scrolling = false;
             });
         }
     });

     function updateTable() {
         $.getJSON("/ctf_scoreboard", function (data) {
             current_round = data.current_round;
             scoreboard_round = data.round;
             if (seconds_left <= 0) {
                 seconds_left = data.seconds_left;
                 updateCountdown();
             }

             var rows = data.scores.map(function (t) {
                 var row = {
                     team: $("<td>")
                         .addClass("align-middle")
                         .append($("<div>").addClass("font-weight-bold").text(t.name))
                         .append($("<small>").text(t.ip)),
                     score: renderScore(t)};
                 Object.keys(t.services).forEach(function (s) {
                     row[s] = renderService(t.services[s]);
                 });
                 return row;
             });
             table.rows.load(rows);

             $("#rnd-scores").text(scoreboard_round -1);
             $("#rnd-current").text(current_round);

             if (scoreboard_round != current_round)
                 $("#freezeinfo").show();
             else
                 $("#freezeinfo").hide();
         });
     }

     if (localStorage.getItem('ticks-to-display')) {
         $("#ticktodisplay").val(localStorage.getItem('ticks-to-display'))
     }
     $("#tickstodisplay-refresh").click(function (){
         var ticks = $("#ticktodisplay").val()
         if (ticks) {
             localStorage.setItem("ticks-to-display", ticks)
         } else {
             localStorage.removeItem("ticks-to-display")
         }
         updateChart()
     });

     if (JSON.parse(localStorage.getItem('show-all-teams'))) {
         $("#showallcheckbox").attr("checked", true)
     }
     $("#showallcheckbox").change(function () {
         var current = JSON.parse(localStorage.getItem('show-all-teams'))
         localStorage.setItem('show-all-teams', !current)
         console.log(localStorage.getItem('show-all-teams'))
         updateChart()
     })
     
     function updateChart() {
         var ticks_to_display = (localStorage.getItem('ticks-to-display') |0) || 20;
         
         $.getJSON(`/ctf_stats/${ticks_to_display}`, function (scores) {
             if (!scores) return;

             scoreGraph.data.labels = []
             scoreGraph.data.datasets = []

             // top 10 teams
             var topteams = Object.keys(scores)
             var show_all_teams = JSON.parse(localStorage.getItem('show-all-teams'));
             scoreGraph.options.title = { display: false }
             if (!show_all_teams) {
                 scoreGraph.options.title = { display: true, text: 'Top 10' }
                 topteams.sort(function (teamA, teamB) {
                     return (scores[teamA][current_round-1] - scores[teamB][current_round-1])
                 }).reverse()
                 topteams = topteams.slice(0,9)
             }
             
             for (var team of topteams) {
                 if (scoreGraph.data.labels.length == 0) {
                     scoreGraph.data.labels = Object.keys(scores[team]).map(parseFloat)
                 }
                 var color  = '#' + intToRGB(hashCode(team + 'Oht3xZg8'));
                 scoreGraph.data.datasets.push({
                     label: team,
                     data: Object.values(scores[team]),
                     backgroundColor: color,
                     borderColor: color,
                     borderWidth: 3,
                     pointRadius: 0,
                     pointHitRadius: 4,
                     fill: false
                 })
             }
             scoreGraph.update()
         });
     }

     function updateCountdown() {
         seconds_left--;
         var s = seconds_left % 3600;
         var hours = Math.floor(seconds_left / 3600);
         var minutes = Math.floor(s / 60);
         var seconds = s % 60;
         $("#countdown").text(hours + " h, " + minutes + " m, " + seconds + " s");
         if (seconds_left < 0) $("#countdown-container").hide()
         else $("#countdown-container").show()

     }

     updateCountdown();
     updateTable();
     updateChart();
     setInterval(function () {
         if (seconds_left <= 0 || seconds_left % update_period == 0) {
             updateTable();
         }
         if (seconds_left % (update_period * 10) == 0) {
             updateChart();
         }
         updateCountdown();
     }, 1000);
 });
</script>

<script language="javascript" type="text/javascript" src="{{ url_for('static', filename='js/amcharts.js') }}"></script>
<script language="javascript" type="text/javascript" src="{{ url_for('static', filename='js/serial.js') }}"></script>
<script language="javascript" type="text/javascript" src="{{ url_for('static', filename='js/chart_dark.js') }}"></script>
<script language="javascript" type="text/javascript" src="{{ url_for('static', filename='js/amstock.js') }}"></script>
<script language="javascript" type="text/javascript" src="{{ url_for('static', filename='js/ad_charts.js') }}"></script>


{% endblock %}
